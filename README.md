---
title: "Assortative mating, sexual selection and their consequences for gene flow in _Littorina_"
date: "11th October 2019"
author: "Samuel Perini et al."
csl: evolution.xml
bibliography: Lsax_mating.bib
---

# MANUSCRIPT

The Formation of new species requires reproductive isolation through the accumulation of barriers to gene flow. Assortative mating can be a crucial prezygotic barrier because it can generate strong linkage disequilibrium (LD) between alleles at different loci [@kirkpatrickandravigne2002]. During the build-up of reproductive isolation, when two populations still exchange genes/migrants, a strong barrier effect will be achieved if assortative mating is associated with traits under divergent selection. As the total number of traits that contributes to reproductive isolation is increased, the antagonistic effect of recombination is also increased. Therefore, speciation-with-gene-flow is facilitated when the number of traits is low because there are fewer opportunities for recombination to disrupt associations between barrier effects [@smadjaandbutlin2011]. The formation of these associations is facilitated by ‘multiple-effect’ or ‘magic’ traits that are simultaneously under direct selection and contribute to the mating pattern [@kirkpatrickandravigne2002; @gavrilets2004; @servedio2009; @smadjaandbutlin2011], because then the force of divergent selection is directly transmitted to the mating traits. Examples include wing colour patterns in _Heliconius_ butterflies that contribute to both mimicry and mating signals [@merrill2014; @merrill2019] and colour sensitivity in cichlids that influences both foraging and mate choice [@seehausen1999].  Alternatively, divergently selected traits and traits affecting assortative mating may be indirectly associated via linkage disequilibrium [“reinforcement”; @kirkpatrickandravigne2002]. For example, flower colour in _Phlox_ [@hopkins...] or acoustic signals in frogs [@lemmon...] contribute to assortative mating but are probably not under direct divergent selection.  In either case, the association between divergently-selected and mating traits increases the overall barrier to gene flow [@barton1983; @bartonanddecara2009; @abbott2013].  
The most favourable situation for divergence is when no trait association and no LD is required to maintain association between components for local adaptation and assortative mating [@smadjaandbutlin2011]. This is the case when divergent natural selection acts on an ecological trait, such as habitat choice or flowering time, and mating occurs essentially at random among individuals with the same habitat preference or phenological trait [“matching rule by a grouping mechanism”; @kopp2018; @servedioandkopp2012]. Other multiple-effect traits might connect divergent selection to just one component of the mating pathway, such as a signal or preference, but still reduce the number of isolating traits and so contribute to the progress of speciation [@riceandhostert1993; @servedio2011; @smadjaandbutlin2011]. Assortment based on body size in _Gasterosteus_ sticklebacks [@mckinnonandrundle2002] is an example of a multiple-effect trait underlying a matching rule while wing colour-pattern in _Heliconius_ butterflies [@merrill2014; @merrill2019] contribute to assortative mating primarily through the signal component of a signal-preference system.  
The contribution to overall reproductive isolation that is made by assortative mating can be estimated by breaking down the components of the total isolation [@sobelandchen2014]. However, divergent populations with incomplete isolation are often connected by a hybrid zone containing a cline of intermediate individuals. This is likely to reduce the effectiveness of assortative mating as a barrier to gene flow as well as to require a different approach to the estimation of individual components of reproductive isolation.  
Hybrid zones provide excellent conditions for quantifying to what extent gene flow between distinct populations is reduced by divergent natural selection and assortative mating [@hewitt1988]. At the contact zone between divergent populations, hybrids can form and display a wide range of trait combinations [@barton1985; @mallet2005]. For example, two locally adapted populations can evolve different trait values but, unless selection or assortative mating is very strong, a continuous cline of the trait will be maintained across the habitat boundary. Gene exchange will continue but will be impeded, particularly for loci contributing to selected traits and loci closely linked to them. Assortative mating based on clinally-varying traits might be expected to generate only a weak barrier to gene flow because individuals that meet one-another in the hybrid zone rarely differ much in trait values, allowing little opportunity for discrimination [@irwin2019]. Selection resulting from the reduced fitness of hybrids can, in theory, increase reproductive isolation (reinforcement) but the conditions required are quite stringent [@liou1994; @price2008; but see @servedioandnoor2003].  
Assortative mating can occur without variation in mating success among individuals. However, behavioural interactions between males and females that generate assortative mating will often also generate sexual selection, for example due to competition between males for access to females or sensory biases in female perception of signals [@andersson1994]. As a result, the overall barrier to gene flow between two populations can either increase or decrease depending on whether or not sexual selection promotes assortment [@servedioandboughman2017]. If sexual selection is divergent and acts directly on mating preferences or operates on systems where preferences and mating traits are encoded by the same set of genes, or if mating traits are condition-dependent, premating isolation will be enhanced and the two populations may become reproductively isolated. On the other hand, if sexual selection is convergent or parallel as in the case where mating preferences are absolute and uniform, homogenisation of the mating traits can follow and lead to a reduction in assortative mating which will then hinder the accumulation of barriers to gene flow [@servedioandboughman2017]. However, there are still few empirical studies that have investigated to what extent sexual selection contributes to reproductive isolation [@maanandseehausen2011].  
To understand the impact of departures from random mating on the barrier to gene flow in a hybrid zone, it is necessary to quantify the mating pattern. This should be done in a way that allows consequences of the mating pattern on the distribution of phenotypes to be assessed at all points in the zone, not just for interactions between individuals from divergent, parental populations. Doing so will allow the overall contribution of mating behaviour to the barrier to gene exchange to be estimated and the impacts of assortative mating and sexual selection to be separated. @irwin2019 recently developed a simulation inspired by work on hybrid zones in birds and suggested that the barrier effect established by assortative mating is small, at best. Here, we address this issue in the snail _Littorina saxatilis_, combining extensive empirical data from mating experiments with a model-based approach to quantify the mating pattern in the field. We then use simulations to estimate barrier effects.  
_Littorina saxatilis_ is an intertidal marine snail forming several ecotypes, among which the Wave and the Crab ecotypes (simply “Wave” and “Crab” in the following) are encountered widely in wave-exposed and crab-rich habitats, respectively, over the species’ North Eastern Atlantic distribution [@johannesson2010a; @butlin2014]. Wave individuals live on cliffs, and they have evolved a relatively large foot, thin shell, a bold behaviour and small sizes, whereas Crab snails live among boulders, and differ from the Wave snails by a larger, thicker shell with a narrower foot, showing a wary behaviour. Trait differences between ecotypes are the result of divergent natural selection largely induced by wave action in the wave-exposed habitat and crab predation in the crab-rich habitat [@johannesson1986; @boulding2017; @lepennec2017]. Many genomic regions potentially involved in the divergence process in _L. saxatilis_ have been identified, including several putative inversions [@westram2018; @faria2019; @morales2019].  
Divergent natural selection is a powerful barrier against gene flow between Wave and Crab snail populations but there are also suggestions for other isolating components such as habitat choice, low dispersal (due to direct development) and size-assortative mating [@janson1983; @rolan-alvarez1997; @cruz2004; @johannesson2016]. Assortative mating has been investigated in empirical studies both in the field and the laboratory showing that Crab and Wave ecotypes mated assortatively in sympatry [Yule’s V, IPSI and ri values significantly different from random mating and as high as 0.96; @johannesson1995; @hull1998; @rolan-alvarez1999; @cruz2004; @conde-padin2008] and that female and male sizes in field-collected? mating pairs were highly correlated [Pearson correlation coefficients ≥ 0.3; @rolan-alvarez1999; @johannesson1995; @rolan-alvarez2004]. Assortment is accompanied by a component of sexual selection on size [@ng2019]. Furthermore, copulation time as well as distances that males followed female trails before mating were longer for similar sized pairs. Because the average sizes of the ecotypes are very different (adult Crab snails are 2-3 times larger than adult Wave snails) this generates assortment among ecotypes, with little evidence for effects of traits other than size [@hollander2005; @johannesson2008].  
Generally among littorinid snails, males preferentially track and mate females slightly larger than themselves [‘similarity-like’ mechanism plus a constant; @erlandsson1994; @ng2014; @saltin2013; @fernandez-meirama2017; @ng2019). These results represent strong evidence for the presence of assortative mating in _L. saxatilis_ plus the opportunity for sexual selection. However, for the general reasons discussed above, it is unclear to what extent this assortative mating contributes to the barrier to gene flow between the two ecotypes where they meet in natural contact zones. It is also not known whether sexual selection enhances the reproductive barrier in this system. Hence, we ask what is the barrier effect of size-assortative mating and sexual selection in natural contact zones in these snails? Firstly, we computed the mating probability given encounters between snails with a wide range of sizes and shapes and then used the resulting mating pattern to infer assortative mating and sexual selection across the contact zones between populations of the Crab and Wave ecotypes. Finally, based on the estimates of assortment and sexual selection, we predicted the barrier strengths of these two components of isolation performing individual-based computer simulations.

Materials and Methods  
SAMPLING, PHENOTYPES AND MATING EXPERIMENT  
Along-shore transects including Crab-Wave contact zones were sampled on four small islands on the Swedish west coast. Each sampled transect was approximately 300 m long and included one boulder field (Crab snail habitat) flanked on both sides by cliffs (Wave snail habitat), resulting in two Crab - Wave contact zones per island. The islands were Ramsö (“CZA”, N 58°49'27.8", E 11°03'43.2") sampled in July 2013, Inre Arsklovet (“CZB”, N 58°50'00.4", E 11°08'18.7"), Ramsökalv (“CZC”, N 58°50'04.1", E 11°02'26.8") and Yttre Arsklovet (“CZD”, N 58°49'51.4", E 11°08'00.1") sampled in May and June 2014. The most distant islands, CZC and CZB, were ~5.6 km apart and the other two islands were located at intermediate distances with CZA ~1.6 km from CZC and CZD ~0.4 km from CZB (Google). _Littorina saxatilis_ has direct development without a pelagic larva and the dispersal of adults was estimated by @westram2018 to be about 1.5 m [Supplementary Information S1 Fig. S1; for sampling details, Westram et al. in prep but note that CZC is unique to this study).  
“Test” or focal snails (~600 individuals per location) were collected across the entire length of each transect and their exact position was recorded in three dimensions using a Trimble total station [for details, see @westram2018]. “Reference” snails (used as mate partners, see below) were sampled at a fifth island [“ANG” in @westram2018; N 58°52’15.14“, E 11°7’11.88”) in Crab and Wave habitats away from the contact zone (in total 400 individuals per test shore location). Both reference and test snails were sexed prior to mating experiments based on observation of the male penis. If no penis was observed, individuals were assumed to be females. If the penis was underdeveloped, individuals were considered sexually immature and excluded from the mating experiments. Dissections of test snails followed all experiments in order to confirm initial sex determination and check whether females were immature or parasitised. Trials involving immature or parasitised test individuals, or individuals whose sex had been determined incorrectly, were discarded.  
Size was measured for both reference and test snails as the maximum distance between the top of the apex and the base of the aperture of the shell. Shape was determined only for the test snails and summarised as the first relative warp from a landmark-based geometric morphometrics analysis that captures the Crab-Wave axis [@ravinet2016; @westram2018]. Shell shape of the reference snails was not analysed but considered typical of the Crab or Wave ecotype since they were sampled in habitats far from contact zones.  
In order to find the pattern between mating probability and the recorded traits (size and shape), we tested each of the transect snails in mating trials with snails from the reference site. Each mating trial involved one test snail and one reference snail of the opposite sex. The use of reference snails allowed us to avoid confounding mating patterns driven by snail size (or other traits) with patterns driven by population of origin. The use of test snails from throughout the transects provided a wide range of trait values (and trait values combinations between males and females). Reference snail ecotype and test snail shape (a continuous proxy for ecotype) allowed us to also test for ecotype effects on mating pattern.  
Mating trials were performed indoors at ambient light and room temperature. Snails were placed foot-down at the bottom of a transparent plastic sphere (80 mm in diameter) one-third filled with sea water at room temperature. Plastic spheres were rinsed carefully between trials in order to remove all mucus trails from the previous test. Each test snail was included in four different trials (on different days) so that it was paired twice with a random Crab reference snail, and twice with a random Wave reference snail. Time of day and ordering effects were avoided using a balanced experimental design. Each mating trial (test-reference pair) was monitored for two hours during which male mounting activity was recorded. Upon encountering another snail, males can crawl onto and around the shell of the other individual until arriving at a characteristic mounting position on the right hand side of the partner’s shell, inserting the penis under the shell and exploring the mounted snail’s sex. If it is another male (or another species), the mating attempt is interrupted, while if it is a female, mating may continue [@saur1990]. Male mounting position is a reliable proxy for a copulation attempt in L. saxatilis [@hollander2005], and a positive correlation between mounting duration and the probability that the female received sperm has been observed in other littorinid species [@hollander2018]. If either the test or reference snail was inactive throughout the two-hour trial, this trial was excluded from analysis. In the analyses presented here, we consider only whether or not a mating occurred in each trial. A positive outcome was recorded if the male was in the mounting position for more than 1 minute [@saur1990].

DATA ANALYSIS
For each mating pair, there was information about whether a mating event was observed or not, the island where the test snail was collected (CZA, CZB, CZC or CZD), its shape value, the ecotype of the reference snail (Crab, Wave), the sex of the test snail (and therefore of the reference snail) and the sizes of the two snails, which were used to calculate the ratio between the female and male size for each mating pair.  
Previous work suggests that the size of the male relative to the female size is the primary determinant of mating, given an encounter [@conde-padin2008]. We began by checking whether our observations are consistent with this result.  Using the function glm() in R version 3.5.0 [@rcoreteam2018] and treating mating as a binomial response we searched for the best models using all possible combinations of seven variables (log(female size), female-male size ratio, size ratio squared, size ratio cubed, ecotype of the reference snail, shape of the test snail and island where the test snails were collected) and their two-way interactions with the exception of interactions between size variables. As expected, the best model, with the lowest Akaike information criterion (AIC = 4251), included effects of size ratio and its square while ln(female size) appeared as a two-way interaction with island. Interactions between size and both shape and island were also included but their effects were relatively small (Supplementary Information S1 Table S1).  
We then fitted the observed data to a model of the relationship between mating probability and only one independent variable, the ratio of female to male size. This model allowed us to estimate parameters that we then applied to size distributions in nature to infer the effects of assortment and sexual selection on the species’ mating pattern. These parameter estimates were also used to simulate the barrier effects of size assortative mating (see below; CLINE SIMULATIONS). Initial trials showed that a symmetrical Gaussian model that is commonly used to describe sexual selection and assortative mating [@lande1981; @gavrilets2004] could not account for our observations because the mating probability declines asymmetrically, more rapidly for males larger than females than for males smaller than females. Therefore, the binary outcome of the mating experiment (mated or non-mated pair) was fitted using logistic regression to a skew normal function of the size ratio:

With denoting the natural logarithm of the female size relative to the male size in mating pair i, erf is an error function, and b_0,b_1,c,d, and α are (unknown) model parameters (see below). For a symmetric normal model, the probability of mating would be highest for a size ratio of c [called ‘preference’ by @kopp2018]. However, in an asymmetric (skew normal) model, the position of the maximum (the ‘optimal size ratio’, OR) also depends on the parameter α, which controls the amount of skew (Fig. 1). The OR was estimated by taking the first derivative of Eq. (1) using WolframAlpha (access October 19, 2018) and finding its root using the function uniroot()in R version 3.5.0 [@rcoreteam2018]. The rate of decline in the probability of mating away from the OR is given by the parameter d [called ‘choosiness’ by @kopp2018; Fig. 1]. Here we refer to d as ‘ratio dependence’ to avoid any implication that one or the other sex is making a choice. Finally, parameters b_0 and b_1 are scaling parameters reflecting the overall minimum and maximum proportion of trials in which mating occurred: we call them the ‘mating baseline’ and the ‘mating rate’, respectively (Fig. 1).

Figure 1. Effects of the parameters on the predicted mating probability.

Model fitting was performed in Stan [@carpenter2017], a probabilistic programming language that adopts full Bayesian statistical inference with Markov Chain Monte Carlo (MCMC) sampling, implemented using the R package ‘rstan’ [@standevteam2018]. The space of the parameters was defined using uniform priors which were bounded according to biologically-reasonable limits (0 to 1 for b_0 and b_1; -10 to 10 for c and α; 0 to 10 for d). The sampling algorithm was set to 8000 iterations and it was repeated four times in parallel. The first 2000 iterations of each of the four chains were not used for the posterior inference as these initial values might confound the posterior mean calculations. The rest of the arguments were left at the default settings.  
Our initial data exploration using generalised linear models suggested that the relationship between mating probability and size ratio might vary according to island and ecotype (or snail shape). We tested the impact of these variables by fitting hierarchical models in Stan. In these models, one or more of the parameters in Eq. (1) was replaced by a ‘hyperparameter’ that was a function of the island from which the test snail was sampled, the test snail shape, the reference snail ecotype and the sex of the test snail (Supplementary Information S2).

MATING PATTERN CONSEQUENCES IN THE FIELD? HYBRID ZONE?  
The parameters of the mating pattern were estimated from the observations in the mating experiment, which was designed to investigate the probabilities of mating given encounters between snails with a wide range of sizes and shapes. The implications of this mating pattern for assortative mating and sexual selection in nature depend on the sizes of snails that actually encounter one another. In turn, this depends on the way the means and variances of male and female size change across the contact zones between populations of the Crab and Wave ecotypes. It may also depend on dispersal, which determines the spatial scale over which individuals can choose their mates [@rolan-alvarez2015]. Therefore, we simulated mating of _L. saxatilis_ in natural conditions, using the parameters of the skew normal function estimated through Bayesian inference, in order to predict the resulting strengths of assortative mating and sexual selection in our transects.  
To obtain the means and variances of male and female size distributions at each point in each transect, we fitted clines to the observed log(size) data. We estimated cline centres and widths, crab and wave ecotype means and the change in variance across the transect by maximum likelihood [‘bbmle’ package in R, function mle2(), @bolkerandteam2017] using equations from @derryberry2014 and R scripts adapted from @westram2018. Clines were fitted for each island separately using the shell sizes of the test snails grouped by sex and their position on the shore [on a one-dimensional transect, see @westram2018] where they were sampled (Supplementary Information S3).
Mating simulations were run for each of the four islands separately. Each run consisted of repeated sampling of female and male sizes from the fitted phenotypic cline, at positions from one end to the other of the transects. The positions were the island-specific cline centres and a series of equally distributed distances from the centres. The positions were separated by a spatial interval that was smaller than half the cline width in order to include more positions at the contact zone where we expected size distribution to vary and thus the intensity of assortative mating and sexual selection. We assumed that the formation of female-male pairs was constrained within the estimated dispersal of the species [@westram2018] and that female reproductive success was independent of the number of matings due to their highly promiscuous behaviour and capacity of sperm storage in the wild [@panova2010, @johannesson2016, but see @ng2019 who assume that female fitness increases with number of matings].
At each transect position, T_f, 1000 random size values were drawn, for females, from a normal distribution with the mean and standard deviation (SD) predicted from the fitted cline. For each female, we drew a male position T_m=T_f+ξ, where ξ is a random number from a normal distribution with mean, 0, and standard deviation σ that corresponds to the estimated dispersal of the species [1.5 m; @westram2018]. We then drew a size for that male using the mean and standard deviation of male size from the cline fit for position T_m and determined the probability that an encounter between this pair of individuals would lead to a mating using their size ratio and the skew-normal distribution with our estimated parameters. Whether or not a mating occurred was then determined by a random draw from the binomial distribution with this probability of mating. If no mating occurred, a new male was drawn and the process was repeated until the female mated. We recorded the sizes of males and females in each encounter and the mating outcome. This pipeline was replicated ten times at each position along the transect to ensure repeatability of our estimates of assortative mating and sexual selection.
The strengths of assortative mating and of sexual selection on males were extracted from the simulated data and they were averaged across the ten runs at each cline position on each island. Assortment was measured as the Pearson correlation coefficient of shell size values between males and females in mated pairs while sexual selection was estimated as (i) the difference in mean size of mated males compared to mated plus non-mated males (directional component) and (ii) the difference in variance between mated male sizes and all male sizes (stabilising component).

CLINE SIMULATIONS
To further understand the effect of the mating pattern inferred from the experiments, we performed individual-based computer simulations for the evolution of a reproductive barrier along a hybrid zone comparing models with, and without assortative mating. In each model, the habitat consisted of 400 patches arranged linearly, each with 100 diploid individuals (50 males and 50 females). Consecutive patches were assumed to be 1m apart. Generations were discrete and non-overlapping. The lifecycle was modelled in the order: dispersal, recombination and mating locally in each patch, natural selection. In the model, dispersal distance was Gaussian distributed with mean zero and standard deviation  σ=1.5 (in line with the estimate in Westram et al. 2018). We assumed that the trait under selection had an optimum (θ_j) that changed abruptly at the centre of the habitat (between the patches 200 and 201), so that θ_j=2 for patches j=1,2,…,200, and θ_j=-2 for patches j=201,202,…,400. The trait under selection was assumed to be underlain by a set of L=40 loci in females, and a separate set of L=40 loci in males. All loci were assumed to recombine freely. Each locus had additive alleles of effect size α=(|θ_j |)/L or -α, so that overshooting of the local trait optimum was possible. Mating was implemented according to five different models, one being random mating, and the remaining four being different versions of assortative mating (see below). In each model, we assumed that every female produced a large (and the same) number of offspring (i.e. 100), so that there was no sexual selection on females. By contrast, males could have different contributions to the pool of offspring, as per the mating model applied. After reproduction, the adults died, and the pool of offspring in each patch was randomly divided into 50% males and 50% females. To keep the population size constant, we then applied natural selection so that only 50 females and 50 males survived in each patch. The fitness w_(k,j) of an individual k in patch j depended on the distance of the individual’s trait value z_(k,j) from the optimum θ_j in the patch according to
                                                         w_(k,j)=e^(-〖(z_(k,j)-θ_j)〗^2/(2 σ_s^2 )) .                                                  (2)
Here, σ_s is the inverse of the strength of natural selection. We chose it so that an individual that is perfectly adapted to one habitat end had a fitness equal to 0.7 in the other habitat end, and vice versa. This corresponds to the selection disadvantage of 0.3,
As mentioned above, we simulated five different mating models: i) random mating, and assortative mating with ii) a skewed mating probability (see Eq. (1)), iii) symmetric mating probability with mean equal to the mean of Eq. (1), and standard deviation equal to d, iv) symmetric mating probability with mean equal to the optimum of Eq. (1) and standard deviation as in model iii), and v) symmetric mating probability with mean 0, and standard deviation as in models iii)-iv).
Each simulation was initialised so that alleles of effect size α were fixed in patches j=1,2,…,200 at all loci (and -α in patches j=201,202,…,400). We then ran each simulation under the random-mating model until approximately a steady state was reached, that is, for 10,000 generations (burn-in period). We performed 200 independent realisations for this burn-in period, and we used the results from the last generation of the burn-in period as initial conditions for the simulations with assortative mating (same initial conditions for each of the four models; see above). We then ran each model with assortative mating for additional 5,000 generations, during which the population reached approximately a steady state.
For the burn-in period (random mating), and for the runs with assortative mating, we collected simulation results from the final generation simulated in each case, and estimated a hybrid index (relative frequency of alleles with effect sizes -α averaged over all loci) in each patch, separately for males, females and all individuals. We then fitted the hybrid index to clines using equations from Derryberry et al. (2014) including symmetric, asymmetric, and tailed clines with one and three independent variances, and R scripts adapted from Westram et al. (2018). For each realisation, the maximum-likelihood values for the estimated cline centres, widths, and hybrid index at the habitat ends were saved for comparison between the different models. Specifically, we approximated the inverse strength of the reproductive barrier in a given model by the estimated cline width (scaled by the difference of the hybrid index between the habitat ends). Therefore, we compared the strength of the reproductive barriers established in the different models by investigating the distributions of the estimated cline widths obtained in the different models in 200 independent realisations.

Results
The raw number of mating trials (all islands included) was 7594 and, after the filtering steps, 4330 trials were used for the downstream analysis. The excluded observations contained 530 mating pairs where the sex of the test snails was misidentified, 968 whose stage of the test snail was juvenile, 292 with parasitised test snails, 1286 where one or both snails was inactive throughout the trial, 70 test snails without spatial information and 118 mating pairs with missing shell sizes.

MATING PATTERN IN THE LABORATORY TRIALS
The first requirement for the quantification of the barrier effect to gene flow due to size assortative mating is to know how the probability of mating varies with respect to female and male size distributions. The non-hierarchical model was built for this objective and it was fitted to the data with all four islands combined (Fig. 2). The probability of mating followed a right-skewed distribution (α= 2.33) with maximum (OR = 0.27 at which point the mating probability = 0.56) displaced from the centre of the distribution (c= -0.17 with ‘mating rate’ b_1= 0.4) and ‘ratio dependence’ (d= 0.85). As the size ratio between the sexes increased/decreased, the mating function approached a probability close to zero for the range of observed size ratios (‘mating baseline’ b_0= 0.01; for 95% confidence intervals (CIs), see Table 1). To give an example of what these values mean in practice, a female of 12.5 mm had the highest probability (0.56) to mate with a male of 9.2 mm (~25% smaller). The same female would mate with a 5 mm male with probability 0.33 or with a 16.5 mm male with probability 0.25, despite their size ratios (0.9 and -0.3, respectively; log(female size) – log(male size)) being equidistant from the OR.
Fitting of hierarchical models showed some significant improvements in the explanation of mating pattern: mating rate (parameter b_1) varied among islands and the centre parameter (c) varied slightly between islands and between reference ecotypes (Supplementary Information S3). Given the small effect sizes, especially for difference in pattern as opposed to rate of mating, we used the non-hierarchical model in the following simulations.

Figure 2. Mating pattern across all islands fitted by the non-hierarchical model followed a right-skewed distribution.

Table 1. Parameter estimates of the non-hierarchical model.

ASSORTATIVE MATING AND SEXUAL SELECTION
After simulating mating encounters, we computed, for each position along the transect of the specific island, the correlation (the Pearson’s r) between female and male sizes in the simulated mated pairs (i.e., assortative mating) and the difference in mean and variance of size of mated males compared to all the males that were simulated at that particular transect position (i.e. sexual selection).
Clines in male and female size were observed close to habitat boundaries on all four islands (Figure 3, Supplementary Information S3 Fig. S1). In all cases, sexual size dimorphism was greater in Wave snails than in Crab snails, the variance in log(size) was also greater in Wave snails and the variance increased in the centres of the clines (Supplementary Information S3 Table S1). Applying the mating pattern model to these size distributions predicts positive size assortative mating for all transect positions in all four Swedish islands. Predicted assortment was strongest at the centres of the clines where the size variance was highest, intermediate in the wave habitat and weakest in the crab habitat where the size variance was the lowest (Fig. 3, Supplementary Information S3 Fig. S1).
Sexual selection was predicted to favour smaller males, and lower variance in male size in all cases (Fig. 3, Supplementary Information S3 Fig. S1). However, the coefficients of sexual selection were also predicted to vary along the transects of the four islands in line with the size variance and difference between female and male sizes. In some cases, the predicted effects were very small. Specifically, the directional component (DSS) was most negative at the centres of the contact zones (high variance), intermediate in the wave habitat (intermediate variance) and close to zero in the crab habitat (low variance). The stabilising component of sexual selection (SSS) showed a similar pattern to DSS.

Figure 3. Assortative mating and sexual selection in the CZB transect.

BARRIER TO GENE FLOW
In all five models we simulated, we found that, at the end of the simulations, the average phenotype of females at the two habitat ends matched their corresponding optimal phenotypes (Fig. 4, solid red lines). For males this was only true under the random mating model, and under the model with Gaussian mating probability with optimum at zero, i.e. with the preference for the same size between the mates (see Fig. 4a and Fig. 4e, where the blue solid line overlaps with the red solid line). In the remaining three models, in each patch males attained on average smaller phenotype values than females (Fig. 4b-d). For symmetric mating functions (Fig. 4c-e), the difference between the optimal phenotype and the average phenotype attained by males at either habitat end was roughly equal to the optimum of the corresponding mating function. Conversely, when the mating function was asymmetric (Fig. 4b), the difference was slightly larger than the optimum of the function (dashed blue line). This is because the mean of the mating function, Eq. (1), was slightly larger than the optimum of the function due to the asymmetry (compare dashed cyan line to the dashed blue line in Fig. 4b). Still, the difference between the attained phenotype of males and their optimal phenotype was slightly larger than the mean of the mating function (blue solid line is between dashed blue and dashed cyan line in Fig. 4b), because natural selection (that acts after mating) favours males with the phenotype closer to the optimum, and the relative contribution to the overall fitness of males further away from the optimum was disproportionate in comparison to the contribution of males closer to the optimum. This made the component of natural selection acting on males effectively stronger in the case of asymmetric mating function (Fig. 4b) than in the case of a symmetric mating function with the optimum equal to the mean of the asymmetric function (case shown in Fig. 4c). We expect that the same was also true when comparing the asymmetric mating model to the remaining three models simulated (Fig. 4a, d, e).

Figure 4. Average phenotype as a function of the patch number, at the end of the simulations for five models of mating: random mating (a), assortative mating with asymmetric mating probability, Eq. (1), consistent with empirical data (b), assortative mating with Gaussian mating probability, with the optimum equal to the mean of the asymmetric mating function (c), or with the optimum equal to the optimum of the asymmetric mating function (d), or with the optimum equal to zero (e). Solid lines show the phenotypes of females (red), or males (blue). Note that blue and red lines overlap in a) and e). Dashed lines show the optimal phenotype at the two habitat ends (red), optimal phenotypes at the two habitat ends minus the optimum of the asymmetric mating function (blue; b, d), and optimal phenotypes at the two habitat ends minus the mean of the asymmetric mating function (cyan; b, c). Vertical dash-dotted line shows the position of the environmental transition. 200 independent realisations of each model.

To test this expectation, we computed hybrid index (HI) in each patch (proportion of alleles with positive effect sizes), and for each realisation of the different models we fitted clines. As expected, the spatial pattern of HI was best explained by a cline model in all cases (not shown). As a proxy for the overall inverse strength of the reproductive barrier in each case, we measured the corresponding cline widths (Fig. 5). The cline widths for the model with asymmetric mating function (estimated from experimental data) were significantly smaller than cline widths for random-mating model (compare the second and first row in Fig. 5): the width less than 40 patches was found in only about 3% of clines obtained under the random-mating model, but in 97% of clines under the model with the asymmetric mating function, Eq. (1). Thus, as expected, the strength of the barrier was much stronger than in the random-mating case (on average, the inverse cline width was about 1.5 times larger in the assortative mating case with the asymmetric mating function than in the random-mating case). We found that assortative mating increased the barrier strength in comparison to that established under the random-mating model also for the remaining three models of assortment (Fig. 5; compare solid vertical lines in the third-fifth row to the corresponding lines in the first row), but the difference to the random-mating model was not as significant as in the case of the asymmetric model estimated from empirical data. Note that among the three symmetric mating models we simulated, the barrier strength was strongest for the model with the optimum equal to the mean of the asymmetric mating function Eq. (1) (Fig. 5, third row), slightly weaker in the case when the optimum was set to the optimum of the asymmetric mating function (Fig. 5, fourth row), and weakest in the case when the optimum was set to zero (Fig. 5, last row). This was because when the optimum of the mating function deviated more from zero (sexual selection component on males), the component of natural selection was stronger (recall that natural selection pushed the males towards the same phenotype optimum as that for females). However, the differences between the three symmetric mating models were subtle.
There were no significant differences in the distribution of the estimated cline widths between HI clines accounting only for males (first column in Fig. 5), or for females (second column in Fig. 5), or for all individuals (third column in Fig. 5).

Figure 5. The distribution of estimated cline widths of hybrid index at the end of the simulations for five models of mating: random mating (a-c), assortative mating with asymmetric mating probability, Eq. (1), consistent with empirical data (d-f), assortative mating with Gaussian mating probability, with the optimum equal to the mean of the asymmetric mating function (g-i), or with the optimum equal to the optimum of the asymmetric mating function (j-l), or with the optimum equal to zero (m-o). We show the results for males only (first column), females only (second column), and all individuals together (third column). Vertical lines show the mean values. 200 independent realisations of each model.  

In all cases, assortative mating (and sexual selection on males) introduced stronger overall selection on males than on females, resulting in a narrower distribution of phenotypes of males than of females (Fig. SI, second to last row). In the random-mating model, by contrast, the two distributions are indistinguishable (Fig. SI, first row).
Finally, in all cases with assortative mating, the sexual selection component strengthened the average linkage disequilibrium between pairs of loci by a factor of about five (Fig. 6).

Figure 6. Average linkage disequilibrium as a function of the patch number at the end of the simulations for five models of mating: random mating (a), assortative mating with asymmetric mating probability, Eq. (1), consistent with empirical data (b), assortative mating with Gaussian mating probability, with the optimum equal to the mean of the asymmetric mating function (c), or with the optimum equal to the optimum of the asymmetric mating function (d), or with the optimum equal to zero (e). 200 independent realisations of each model.

Figure SI. Distribution of phenotypes at two habitat ends at the end of the simulations for five models of mating: random mating (a-b), assortative mating with asymmetric mating probability, Eq. (1), consistent with empirical data (c-d), assortative mating with Gaussian mating probability, with the optimum equal to the mean of the asymmetric mating function (e-f), or with the optimum equal to the optimum of the asymmetric mating function (g-h), or with the optimum equal to zero (i-j). The results for males are shown in the first column (a, c, e, g, i), and for females in the second column (b, d, f, h, j). In each panel, we show the distribution of phenotypes from 30 right-most patches in the habitat (red, distributions on the left), and from 30 left-most patches in the habitat (blue, distributions on the right). 200 independent realisations of each model.

Discussion  
1. The process of speciation can be analysed by studying what traits contribute to reproductive isolation and to what extent they can reduce gene flow between distinct populations. Single traits with multiple barrier effects can represent excellent examples for the formation of new species as they can overcome the opposition of gene flow and recombination during the build-up of reproductive isolation. Here, we investigated the contribution to reproductive isolation of shell size, a single trait with both an effect on ecological isolation and a sexual barrier to gene flow between Crab and Wave ecotypes of L. saxatilis. Our results confirm previous observations, based on sexual isolation indices, of size assortative mating in L. saxatilis. Mated pairs showed a positive correlation in respect to size with females that were slightly larger than males. What is innovative about this study is (i) the application of a model-based approach on an extensive dataset to quantify the mating pattern of L. saxatilis, (ii) the inference of assortative mating and sexual selection parameters resulting from such mating pattern and (iii) the estimation of the strength of the sexual barrier to the reduction of gene flow between ecotypes using computer simulations under a hybrid zone framework. Having this type of knowledge about any biological system of speciation represents a step forwards towards understanding the evolutionary dynamics of speciation-with-gene-flow.
1. In most marine gastropods studied, females and males mate assortatively in relation to size, with the male being smaller than the female for a specific value (for a review, see Ng et al. 2019). Mating pairs of L. saxatilis followed this trend and mated with the highest probability when males were ~25% smaller than females under the conditions of the mating experiment. Furthermore, the relationship between mating probability and size ratio was not symmetrical and there was an advantage for mating pairs composed of a female larger than the male rather than a male larger than the female. Until now, it was unknown in this system how the mating pattern influences the intensity of assortment. There was already evidence for mating being mainly dependent on size after encounter (ref. previous work) and there are now predictions (this study) for the mating pattern to generate size assortative mating which varies across positions of the transect.
1. Another characteristic that was found to be shared among studied marine gastropods was a mating advantage for small males where sexual selection was proposed to maintain size dimorphism in concert with fecundity and viability selection (Ng et al. 2019). We were able to predict that also small males of L. saxatilis were favoured by sexual selection which had both a directional and a stabilising component varying in strength across the boundary between crab and wave habitat. Both components were positively correlated with the amount of size variance or the degree of size dimorphism. This result was consistent across all the four Swedish islands. Sexual size dimorphism is suggested to drive sexual selection and our results agree with this scenario. In general, smaller males than average are more likely to mate but this advantage decreases as the males become larger or smaller than the sexual selection optimum. Males with extreme sizes might incur into physical mating constraints with the most frequent females such as the female capacity to resist wave-action with a male of a certain size in mating position. Natural selection favours large males in the crab area (or maybe everywhere but more strongly in the crab area) to explain the observed difference in dimorphism.
1. The formation of ecotypes can evolve through changes in mating behaviour or reinforcement but it does not seem to be the case for the populations of L. saxatilis where the mating pattern was essentially conserved between the ecotypes. This result fits with the generality of the pattern across littorinids (Ng) to suggest a pre-existing ‘bias’ which would have made ecotype formation easier. These values might change at larger geographical scale especially for Spanish populations where a reanalysis of the data from Spanish wild mating pairs showed that the strength of the mating preference did not increase in sympatry, where both ecotypes were present, compared to a situation where only one ecotype occurred (Fernández-Meirama et al. 2017). Although the causes remain unclear in L. saxatilis, potential constraints such as the costs of the preference and the possible polygenic structure of mate choice have been theoretically described to oppose differentiation of the mating preference which will inevitably slow down the accumulation of reproductive isolation [@gavrilets2004; @thibertandgavrilets2013; @servedio2016].
1. If we assume that size assortative mating was an ancestral trait it must have evolved in response to something different than the differences in size of Crab and Wave. Our results can hint at a mechanism of assortment that had originated before the formation of the ecotypes. However, our data cannot explain this process. What we were able to conclude was that, as a consequence of divergent natural selection on size that has generated distinct optima at the local habitat, the resulting mating pattern is expected to be a marginal component of reproductive isolation between Crab and Wave ecotypes.
1. Current barrier effect of assortative mating, current impact of sexual selection on clines in size.
1. Some speculation about impact on the origin of ecotypes.
1. Broader comparison (i.e. beyond Littorina) on multiple-effect traits and on barrier effects of assortment in HZs (compare to Irwin and to Jiggins & Mallet, maybe Wolf, maybe Gay et al…).


# TOADD

## Intro

## Methods

## Results

## Discussion  
Models of assortative mating typically assume that individuals mate with similar individuals with no difference in mating success. However, in natural populations where individuals mate assortatively, rare phenotypes undergo a mating disadvantage which can generate stabilsing sexual selection [@kirkpatrickandnuismer2004].

# References
