---
title: "Mating model for the four contact zones"
author: "Samuel Perini"
output: pdf_document
csl: journal-of-evolutionary-biology.csl
bibliography: library.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


This report includes two logistic regression models that aim to describe the mounting probability in the species _Littorina saxatilis_. The first generalised linear model applies a Bernoulli distribution to the discrete response variable (i.e., mounting success) and generates coefficient estimates for the explanatory variables using maximum likelihood. The second one is also based on a Bernoulli distribution but it uses Bayesian statistics to estimate unknown parameters given the data and a set of prior distributions. It exploits the relationship between the size ratio of the mating pairs and the proportion of successful mountings (Fig. 1). 

## Data visualisations

$\vspace{0.5cm}$

```{r fig1, fig.height=4, fig.width=6, fig.align='center', echo=FALSE}
CZ_glm = read.csv("../CZ_ABCD/final_data/CZABCD_clean.csv",sep = ";")
breaks <- c(-2,seq(-1.5,1.3,0.15),2)
bin <- cut(CZ_glm$size_ratio,breaks)
p_m_obs <- aggregate(CZ_glm$mountYN,by=list(bin,CZ_glm$shore,CZ_glm$ref_ecotype),FUN=mean)[,2:4]
bin_mean <- aggregate(CZ_glm$size_ratio,by=list(bin,CZ_glm$shore,CZ_glm$ref_ecotype),FUN=mean)[,4]
CZ_glm$count = 1
bin_sum <- aggregate(CZ_glm$count,by=list(bin,CZ_glm$shore,CZ_glm$ref_ecotype),FUN=sum)[,4]
CZ_glm_bin <- data.frame(cbind(shore=p_m_obs[,1],ref_ecotype=p_m_obs[,2],mount=p_m_obs[,3],
                               size_ratio=bin_mean,count=bin_sum))
CZ_glm_bin$shore = as.factor(CZ_glm_bin$shore)
levels(CZ_glm_bin$shore) = c("CZA","CZB","CZC","CZD")
CZ_glm_bin$ref_ecotype = as.factor(CZ_glm_bin$ref_ecotype)
levels(CZ_glm_bin$ref_ecotype) = c("crab","wave")
library(ggplot2)
CZ_glm_bin$line = 0
ggplot(data = CZ_glm_bin,aes(size_ratio,mount,col=as.factor(ref_ecotype))) +
  geom_point(aes(size=CZ_glm_bin$count)) +
  geom_vline(xintercept = CZ_glm_bin$line) +
  facet_wrap(~ as.factor(CZ_glm_bin$shore)) +
  scale_color_manual(values=c("gold2","blue")) +
  labs(col="ref ecotype",size="bin size",x="female size - male size (ln)",
       y="proportion of mounts in each bin",title = "Observed mounting") +
  theme(legend.title = element_text(size = 11,face = "bold"),
        axis.title = element_text(face = "bold"),
        plot.title = element_text(size = 13,face = "bold",hjust = 0.5))
```
\fontsize{8}{9}
\selectfont
Figure 1. **Normal distribution of the frequency of mounting success against the shell size difference in mating pairs.** Each dot consists of the average number of mounting events occurred within a specific range of shell size (0.15 in the log scale). The number of mating pairs for each size interval is proportional to the dimensions of the points (yellow = crab reference ecotype, blue = wave reference ecotype). 
\normalsize

\newpage

## Materials and methods

**1. Standard logistic regression**

All possible mating models have been generated using additive effects and two-way interactions between a total of seven explanatory variables (i.e., female size, test shell shape, ratio between female and male shell size, ratio squared, ratio cube, reference ecotype and shore). The various model subsets had the common binary response defined as mounting success. The final logistic regression model was selected according to two information criteria, AIC and BIC, because the top four models showed a non-significant difference for either the criterion (default threshold of 2).

```{r}
CZ_crit = read.csv("../CZ_ABCD/results/CZABCD_bestsub.csv",sep = ";")

# final model with the lowest AIC and BIC
(ABIC = with(CZ_crit,frml[AIC <= 3853 & BIC <= 3930]))

# models with the lowest AIC
(AIC = with(CZ_crit,frml[AIC >= 3851 & AIC <= 3853]))

# model with the lowest BIC
(BIC = with(CZ_crit,frml[BIC >= 3922 & BIC <= 3924]))

```


$\vspace{1cm}$

All the above models contains similar effects with the exception of those that include the interaction with the reference ecotype. This coefficient appears in four out of six top models and it holds a crucial role for the biological interpretation of the mating pattern. A significant interaction with the reference ecotype would indicate a potential influence of the ecotype variation on the probability of mounting (Table 1). A scenario in which assortative mating occurred by ecotype would corroborate previous studies that identified a predominant role of ecotype and shell shape in mating frequency, copulation time and mucous trail discrimination [@Hollander2005; @Johannesson2008]. The most evident effect of the reference ecotype is mainly observed in shore CZD where the size ratio optimum differs between mating pairs of the crab and wave reference snail (Fig. 1). This unique pattern in connection with the lower proportion of mounting success might suggest to treat CZD as an outlier shore. **(comments needed)**

$\vspace{0.5cm}$

\small
```{r table1, echo=FALSE, results='asis'}
library(descr, quietly = TRUE)
library(pander)
CZ_eco_mod = glm(mountYN ~ size_ratio2+log_female:shore+Shape:ref_ecotype+size_ratio:ref_ecotype+
                   size_ratio3:shore, family = binomial, data = CZ_glm)
pander(CZ_eco_mod)
```
\normalsize

\newpage

**2. Gaussian formulation**

The mating Gaussian formula is a hierarchical model built under a Bayesian framework that allows to predict the probability of mounting success and to estimate directly the parameters for sexual selection $\sigma$ and assortative mating $\mu$. It is hierarchical because the prior distribution for the parameters are given an additional layer of information in order to maintain sufficient flexibility or uncertainty for potential data points that do not strictly follow our expectations. The formula can also account for the strength of mate choice because the mean and the standard deviation of the mounting probability curve can be treated as the amount of trait correlation in the successful pairs (i.e., assortment component or preference) and the measure of variation in mounting success within one sex (i.e., sexual selection component or choosiness), respectively. To give an example, when $\mu = 0$, the most successful pairs are those with no difference in size between the female and the male (like mates with like scenario). Other values of $\mu$ instead would indicate a favourable size ratio which could be either negative (females smaller than males scenario) or positive (females larger than males scenario). All three scenarios involve a non-zero effect of assortative or disassortative mating. 

_However, this might need further attention because assortative mating is never absent in the model._ **(comments needed)**

$\vspace{0.5cm}$

This equation aims to model the relationship between size ratio and the proportion of successful mounting events using a Gaussian formulation surrounded by two terms (i.e., $level$ and $rtail$) which allow for deviations from the standard bell-shaped curve (Fig. 1). 

$$mountYN_i \sim Bin(1, p_i), logit(p_i) = level_i + \frac{1}{\sqrt{2 \pi \sigma_i^2}} e^{-\frac{(ratio_i-\mu_i)^2}{2\sigma_i^2}} + rtail_i$$

The term $level$ controls for the height (not the peak) of the curve and it is defined by $\alpha$, $\delta$ and $\beta$ parameters such that:

$$level_i = \alpha_{\mbox{shore}_i} + \delta_{\mbox{eco}_i} + \beta * shape_i$$

The term $\mu$ is the mean of the curve and it determines the value of size ratio with the highest probability of mounting, the peak of the curve. This component is dependent on three covariates and respective parameters $\alpha\_av$, $\delta\_av$ and $\beta\_av$:

$$\mu_i = \alpha\_av_{\mbox{shore}_i} + \delta\_av_{\mbox{eco}_i} + \beta\_av * shape_i$$

The term $\sigma$ controls for the standard deviation or width of the bell curve and it depends on the covariates shore, ecotype and shape according to the following relationship:

$$\sigma_i = \alpha\_sd_{\mbox{shore}_i} + \delta\_sd_{\mbox{eco}_i} + \beta\_sd * shape_i$$

Finally, the component $rtail$ constitutes the linear effect that captures the observed asymmetry between the left and right end tail of the curve. It is defined as:

$$rtail_i = \alpha\_ta_{\mbox{shore}_i} + \delta\_ta_{\mbox{eco}_i} +\gamma\_ta * size\_ratio_i + \beta\_ta * shape_i$$

$\vspace{0.5cm}$

The terms of the main equation are defined as linear effects of the phenotypic variables measured during the mating experiment. Each explanatory variable is associated with either an intercept parameter (i.e., $\alpha$'s or $\delta$'s) or a regression coefficient (i.e., $\beta$'s or $\gamma$). The intercept and regression coefficients are the unknown and desired parameters whose posterior distributions are sampled from weakly informative priors as recommended by the Stan authors [[web reference](https://github.com/stan-dev/stan/wiki/Prior-Choice-Recommendations)]. Suitable priors for logistic regression coefficients are Student-t distributions because they present light tails that can adapt reasonably well to the data while enabling the production of robust posterior distributions [@Ghosh2017]. However, our model did not reach convergence when these guidelines were transferred to our data. Although the present analysis computes the predicted probability of mounting using a Bernoulli distribution, the final choice of the prior distributions was based on the recommendations for hierarchical models [@Gelman2006]. The half-Cauchy family was selected to restrict very large values of standard deviations and to improve the behaviour around 0.

The importance of each coefficient is established by its posterior distribution which also corresponds to the uncertainty of the parameter estimate. A parameter with posterior distribution that is centred at zero is indicative of an irrelevant effect of the corresponding covariate on the probability of mounting. The opposite is true when the mean of the posterior distribution is shifted from zero.

$\vspace{1cm}$

## Preliminary results and discussion

**1. Standard logistic regression**

The AIC values do not point towards one single and consistent relationship between the explanatory variables and mounting success whereas the results from the BIC can be used to identify the best model. If the two criteria are combined, the model with both the lowest AIC and BIC shows a significant effect of shape, size ratio, size ratio squared, interaction between female size and shore and between shore and size ratio cube (Table 2).

$\vspace{0.5cm}$

\small
```{r table2, echo=FALSE, results='asis'}
CZ_log_mod = glm(mountYN ~ Shape+size_ratio+size_ratio2+log_female:shore+size_ratio3:shore,
                 family = binomial,data = CZ_glm)
pander(CZ_log_mod)
```
\normalsize

$\vspace{1cm}$

The model selection procedure based on the two information criteria requires an additional step to assess the performance of the logistic regression. The ability to predict the response variable mounting success can be estimated using re-sampling techniques such as cross-validation and bootstrap. In our case, repeated 10-fold cross-validation was applied before the measurement of accuracy for each top models. There is no evident difference between accuracy estimates and all the model coincides in terms of predictive performance (Table 3). However, the biological implications can be rather different when the model includes the ecotype term (Mod2, Mod3, Mod4 and Mod5). 

$\vspace{0.5cm}$
\newpage
\fontsize{8}{9}
\selectfont
\begin{center}
Table 3. Performance estimates of the six top model.
\end{center}
\small
```{r table3, message=FALSE, warning=FALSE, echo=FALSE}
library(caret)
library(pROC)
CZ_glm$mountYN <- as.factor(ifelse(CZ_glm$mountYN==1,"yes","no"))
IC = unique(unlist(list(AIC,BIC,ABIC)))
# Data partitioning
inTrain <- createDataPartition(CZ_glm$mountYN, p = .8)[[1]]
CZ_glmTrain <- CZ_glm[ inTrain, ]
CZ_glmTest  <- CZ_glm[-inTrain, ]
# random partition in 10 sets replicated 10 times
objControl.glm <- trainControl(method='repeatedcv', number=10, repeats = 5,
                               classProbs = TRUE, selectionFunction = "oneSE")
# logistic regression of six the top models for each set and replicate
CZ_mods.glm = lapply(as.character(IC), function(frml) train(as.formula(frml), data=CZ_glmTrain,
                                                            method ='glm',family =binomial,
                                                            trControl=objControl.glm))
# accuracy of each top model to predict mounting success
# number of true negatives (pred no, ref no), false positives (no,yes), 
# false negatives (yes,no) and true positives (yes,yes)
predictedClasses <- predict(CZ_mods.glm, CZ_glmTest)
CZ_acc.glm = lapply(predictedClasses, function(mod) confusionMatrix(mod, CZ_glmTest$mountYN))
CZ_accu = sapply(CZ_acc.glm, "[", c("overall"))
CZ_accu = as.data.frame(CZ_accu)
names(CZ_accu) = c("Mod1","Mod2","Mod3","Mod4","Mod5","Mod6")
# from logit to probabilities 
predictedProbs <- predict(CZ_mods.glm, newdata = CZ_glmTest, type = "prob")
# extract only the probability of mounting success
predictedProbs = sapply(predictedProbs, "[", c("yes"))
# calculate the are under the curve
CZ_auc = sapply(predictedProbs, function(probs) roc(CZ_glmTest$mountYN,probs))["auc",]
CZ_auc = as.data.frame(CZ_auc)
row.names(CZ_auc) = "AUC"
names(CZ_auc) = c("Mod1","Mod2","Mod3","Mod4","Mod5","Mod6")
panderOptions('table.split.table',Inf)
panderOptions('table.caption.prefix', '')
pander(rbind(CZ_accu,CZ_auc))
```
\normalsize

$\vspace{0.5cm}$

An area under the curve (AUC) between 0.70 and 0.80 is typical of models that fairly discriminate between negative and positive results [[web reference](https://kennis-research.shinyapps.io/ROC-Curves/)]. All the six models would be appropriate for the description of the relationship between the probability of mounting and the shell dimensions (Fig. 2). 

Shape and size ratio were obvious candidates for the models but female size is quite surprising and might affect the meaning of the mounting relationship. Perhaps male size should be added too. The second unexpected result is the equality in terms of model performance between the regressions with and without the interaction of shape and reference ecotype. All the models are statistically plausible, graphically indistinguishable but biologically ambiguous. **(comments needed)**

$\vspace{0.5cm}$

```{r fig2, out.width='.49\\linewidth', fig.height=4, fig.width=6, fig.show='hold', fig.align='center', echo=FALSE}
objModel.glm = train(mountYN ~ size_ratio+size_ratio2+log_female:Shape+log_female:shore+
                       size_ratio3:shore,
                      data = CZ_glm,
                      method='glm', family=binomial,
                      trControl=objControl.glm)
CZ_glm$mount_probs = predict(objModel.glm$finalModel, type = "response")
CZ_glm$line = 0
ggplot(data = CZ_glm,aes(size_ratio,mount_probs,col=ref_ecotype)) +
  facet_wrap(~ as.factor(CZ_glm$shore)) +
  geom_point(size=0.8) +
  geom_vline(xintercept = CZ_glm$line) +
  scale_color_manual(values=c("gold2","blue")) +
  labs(col="ref ecotype",size="bin size",x="female size - male size (ln)",
       y="predicted probability of mounting", title = "Predicted mounting probability") +
  theme(legend.title = element_text(size = 11,face = "bold"),
        axis.title = element_text(face = "bold"),
        plot.title = element_text(size = 13,face = "bold",hjust = 0.5))

ggplot(data = CZ_glm_bin,aes(size_ratio,mount,col=as.factor(ref_ecotype))) +
  geom_point(aes(size=CZ_glm_bin$count)) +
  geom_vline(xintercept = CZ_glm_bin$line) +
  facet_wrap(~ as.factor(CZ_glm_bin$shore)) +
  scale_color_manual(values=c("gold2","blue")) +
  labs(col="ref ecotype",size="bin size",x="female size - male size (ln)",
       y="proportion of mounts in each bin",title = "Observed mounting") +
  theme(legend.title = element_text(size = 11,face = "bold"),
        axis.title = element_text(face = "bold"),
        plot.title = element_text(size = 13,face = "bold",hjust = 0.5))
```
\small
Figure 2. **Comparison between predicted probabilities and observed mounting events.** Relationship between the difference in shell size of the mating pairs and the predicted probability of mounting success under one of the top six logistic regression models, each dot consists of one mating pair (left-hand side). Main relationship between the difference in shell size of the mating pairs and successful mounting events, each dot consists of the average number of events occurred within a specific size difference of 0.15 in the log scale (right-hand side).   
\normalsize


\newpage
Alternatives to generalised linear models are other classification models such as random forest or discriminant analysis (and there are many many more). Nevertheless, if the best subset selection step is maintained, these new methods might only return a higher or lower accuracy without a proper rejection of some of the top six models. One or two alternative methods should be fairly straightforward to implement into the present pipeline and then compare it with the logistic regression metrics. Here, I have only reported the Bayesian substitute.

$\vspace{0.5cm}$

**2. Gaussian formulation**

Most of the parameters coefficients are centred close to zero to a degree of uncertainty that depends on the different type of shores (Fig. 3, left panel), on the variation in the reference ecotype (Fig. 3, middle panel), on the shape of the test snails and size ratio of the mating pairs (Fig. 3, right panel). Particularly, the first three contact zones, CZA, CZB and CZC, show consistent parameter values compared to the fourth contact zone CZD which is determined by a lower $\alpha$ and smaller $\alpha\_ta$. Negative coefficients of these parameters correspond to a reduced $level$ or curve height and a weak $rtail$ or asymmetry between right and left end tails (Fig. 4). The terms $level$ and $rtail$ show also a distinction between ecotypes (Fig. 3, middle panel). The mating pairs composed by the wave reference are predicted to yield the lowest probability of mounting success (Fig. 4, bottom-left) and a nearly neutral asymmetry in successful events across the two ends of the probability curve (Fig. 4, bottom-right).

The other parameter that shows a shore-specific trend is $\alpha\_sd$ as it takes negative values only in shore three (CZC) and determines the lowest estimates of the term $\sigma$ (Fig. 5).

$\vspace{0.5cm}$

![left panel](../CZ_ABCD/figures/CZ_ABCD_gau1_alphas.pdf){ width=33% } ![middle panel](../CZ_ABCD/figures/CZ_ABCD_gau1_deltas.pdf){ width=33% } ![right panel](../CZ_ABCD/figures/CZ_ABCD_gau1_betas.pdf){ width=33% }
\fontsize{8}{9}
\selectfont
Figure 3. **The range of the parameter values is indicative to the effect of the associated covariate on the probability of mounting.** Mean (black filled dot), 80% (red line) and 90% (black line) confidence intervals of the parameter posterior distribution. The left panel shows the first intercept coefficients $\alpha$'s for each shore (one = CZA, two = CZB, three = CZC, four = CZD), the middle panel contains the second intercept coefficients $\delta$'s for each ecotype (one = crab, two = wave) and the right panel illustrates the regression coefficients $\beta$'s and $\gamma$ for shape and size ratio, respectively. A mean estimate equal to zero corresponds to a negligible effect of the associated explanatory variable.
\normalsize

$\vspace{0.5cm}$

```{r fig4a, out.width='.49\\linewidth', fig.height=4, fig.width=6, fig.show='hold', fig.align='center', echo=FALSE, message=FALSE}
CZ_bayes = read.csv("../CZ_ABCD/final_data/CZABCD_final_data.csv",sep = ";")
#CZ_bayes$shore = as.factor(CZ_bayes$shore)
#levels(CZ_bayes$shore) = c("CZA","CZB","CZC","CZD")
#CZ_bayes$ref_ecotype = as.factor(CZ_bayes$ref_ecotype)
#levels(CZ_bayes$ref_ecotype) = c("crab","wave")
ggplot(data = CZ_bayes,aes(size_ratio,y_rep,col=as.factor(ref_ecotype))) +
  facet_wrap(~ as.factor(CZ_bayes$shore)) +
  geom_point(size=0.8) +
  geom_vline(xintercept = CZ_bayes$line) +
  scale_color_manual(values=c("gold2","blue")) +
  labs(col="ref ecotype",size="bin size",x="female size - male size (ln)",
       y="predicted probability of mounting", title = "Predicted mounting probability") +
  theme(legend.title = element_text(size = 11,face = "bold"),
        axis.title = element_text(face = "bold"),
        plot.title = element_text(size = 13,face = "bold",hjust = 0.5))

ggplot(data = CZ_glm_bin,aes(size_ratio,mount,col=as.factor(ref_ecotype))) +
  geom_point(aes(size=CZ_glm_bin$count)) +
  geom_vline(xintercept = CZ_glm_bin$line) +
  facet_wrap(~ as.factor(CZ_glm_bin$shore)) +
  scale_color_manual(values=c("gold2","blue")) +
  labs(col="ref ecotype",size="bin size",x="female size - male size (ln)",
       y="proportion of mounts in each bin",title = "Observed mounting") +
  theme(legend.title = element_text(size = 11,face = "bold"),
        axis.title = element_text(face = "bold"),
        plot.title = element_text(size = 13,face = "bold",hjust = 0.5))
```

```{r fig4b, out.width='.49\\linewidth', fig.height=5, fig.width=7, fig.show='hold', fig.align='center', echo=FALSE, message=FALSE}
ggplot(CZ_bayes,aes(log_female,log_male,shape=ref_ecotype,col=sim_le)) +
  facet_wrap(~ as.factor(CZ_bayes$shore)) +
  geom_point(size=1.5) +
  scale_color_gradient2(low = "black", mid = "grey", high = "white", midpoint = -0.7) +
  labs(shape="ref. ecotype", col="level", x="female size (ln)",
       y="male size (ln)", title = "Predicted curve intercept") +
  theme(legend.title = element_text(size = 11,face = "bold"),
        axis.title = element_text(face = "bold"),
        plot.title = element_text(size = 13,face = "bold",hjust = 0.5))

ggplot(CZ_bayes,aes(log_female,log_male,shape=ref_ecotype,col=sim_ta)) +
  facet_wrap(~ as.factor(CZ_bayes$shore)) +
  geom_point(size=1.5) +
  scale_color_gradient2(low = "black", mid = "grey", high = "white", midpoint = -0.5) +
  labs(shape="ref. ecotype", col="tail asymmetry", x="female size (ln)",
       y="male size (ln)", title = "Predicted tail asymmetry") +
  theme(legend.title = element_text(size = 11,face = "bold"),
        axis.title = element_text(face = "bold"),
        plot.title = element_text(size = 13,face = "bold",hjust = 0.5))
```
\fontsize{8}{9}
\selectfont
Figure 4. **Visual evaluation of the ability of the Gaussian model to fit the observed data and to generate predictions for the terms $level$ and $rtail$**. The lowest mounting probability and the leasr asymmetry are predicted in shore CZD (top panels). The intercept declines as the reference snail belongs to the wave ecotype and the test snail is progressively crab-like. The asymmetry decreases as the males become larger than the females and the reference morph is classified as crab (bottom panels). Size and shape are positively correlated.
\normalsize

$\vspace{0.5cm}$

The shore effect extends also to the term $\mu$ but I am going to limit my interpretations because I would like to hear **your opinion** on the biological relevance of tiny but evident numerical differences in the parameter estimates (Fig. 6, left panel).

* The value of $\mu$ is positive in all the shores and it ranges between 0.1 and 0.3. A single value could be assigned to all the locations because the coefficients of $\alpha\_av$'s are basically 0 (Table 4).

$\vspace{0.5cm}$

\fontsize{8}{9}
\selectfont
\begin{center}
Table 4. Generated estimates for the shore parameters. All the intervals contain the value 0
\end{center}
\small
```{r table4, message=FALSE, warning=FALSE, echo=FALSE, results='asis'}
CZ_gau2_alpha = read.csv("../CZ_ABCD/results/CZABCD_gau2_alpha.csv",sep = ";")
names(CZ_gau2_alpha) = c("parameter","mean","se_mean","sd","2.5%","25%","50%","75%","97.5%","n_eff","Rhat")
pander(CZ_gau2_alpha)

```
\normalsize

$\vspace{0.5cm}$

* The interval estimates of the parameters $\alpha\_av[1]$ and $\alpha\_av[2]$ are slightly positive (Fig. 3, left panel) and they would suggest larger values of $\mu$ in shore CZA and CZB than in CZC and CZD. Therefore, the first two contact zones would show means of the predicted probability curves shifted away from 0 towards positive values. 

* A linear model with response variable $\mu$ and predictors shore, reference ecotype and shape returns very small coefficients for the shore effect but slightly larger ones for the reference ecotype effect (Table 5). 
Are these small values biologically relevant?
Does a difference of -0.08 in $\mu$ between crab and wave reference ecotype matter?

$\vspace{0.5cm}$

\fontsize{8}{9}
\selectfont
\begin{center}
Table 5. Coefficient estimates (95% confidence intervals) of the linear model for the term $\mu$. The exponential transformation was necessary to handle shape values very close to 0. 
\end{center}
\small
```{r table5, message=FALSE, warning=FALSE, echo=FALSE, results='asis'}
CZ_av_ci95 = read.csv("../CZ_ABCD/results/CZABCD_av_ci95.csv",sep = ";")
names(CZ_av_ci95) = c("","2.5%","97.5%")
pander(CZ_av_ci95)
```
\normalsize

$\vspace{0.5cm}$

* The observed relationship in CZC and CZD might depend on the reference ecotype because the size ratio optima are not overlapping as in CZA and CZB (Fig. 1). The resolution of the term $\mu$ might increase under a model with the interaction effect between shore and reference ecotype, and between shape and reference ecotype. The generated $\mu$ estimates would differ by shore (CZA and CZB against CZC and CZD), and by ecotype (CZC and CZD would show one optimum size ratio for the refrence wave and one for the reference crab).

$\vspace{0.5cm}$

Shore variation can partly explain the mating pattern observed in _L. saxatilis_. The four mounting probability curves differ in height, standard deviation and tail asymmetry. Yet, the current Gaussian model provides ambiguous results about the mean points with the highest mounting success. The linear effect that defines $\mu$ could include additional interactions such as between shore and reference ecotype, and between shape and reference ecotype in order to improve the goodness of fit.

The covariate reference ecotype was associated with the second set of intercept parameters and it was treated exclusively as an additive effect because of computational reasons. The next model will contain further parameters for the interaction terms. Major discrepancies between crab [1] and wave [2] parameters are not detected and the absence of an ultimate reference ecotype effect relatively agrees with both the observed data and the standard logistic regression (Fig. 3, middle panel). On the other hand, the Gaussian formulation identifies minor deviations between ecotypes in all the parameters (Table 6). Besides the differences in $level$ and $rtail$ due to the reference ecotype (Fig. 4, bottom panels), other subtle distinctions are found in the term $\sigma$ and $\mu$. The crab individuals show a narrower width of the mounting curve than the wave ones and thus, a stronger impact of sexual selection up to its maximum in CZC (Fig. 5). The second deviation appears when the reference belong to the crab ecotype because the mean of the probability curve is larger than in mating pairs with the wave reference (Fig. 6).
The relevance of the minor differences between crab and wave is not equivalent for all the terms. The most pronounced ecotype distinction is carried by the terms $rtail$ and $level$ (Table 6).

$\vspace{0.5cm}$

```{r fig5, fig.height=5, fig.width=6, fig.show='hold', fig.align='center', echo=FALSE, message=FALSE}
ggplot(CZ_bayes,aes(log_female,log_male,shape=ref_ecotype,col=sim_sd)) +
  facet_wrap(~ as.factor(CZ_bayes$shore)) +
  geom_point(size=1.5) +
  scale_color_gradient2(low = "black",mid = "grey", high = "white",midpoint = 0.26) +
  labs(shape="ref. ecotype", col=expression(sigma~"(exp)"), x="female size",
       y="male size", title = "Predicted sexual selection") +
  theme(legend.title = element_text(size = 11,face = "bold"),
        axis.title = element_text(face = "bold"),
        plot.title = element_text(size = 13,face = "bold",hjust = 0.5))
```
\fontsize{8}{9}
\selectfont
Figure 5. **Strength of sexual selection depends on both the reference ecotype and the shore variation.** Sexual selection is predicted to reduce trait variation the most in mating pairs of the crab reference ecotype and the least in mating pairs of the wave reference ecotype. The lowest values of $\sigma$ are obtained in shore CZC and thus, the strongest effect of sexual selection. Values of $\sigma$ are calculated using the exponential function.
\normalsize

$\vspace{0.5cm}$

```{r fig6, out.width='.49\\linewidth', fig.height=5, fig.width=6, fig.show='hold', fig.align='center', echo=FALSE}
ggplot(CZ_bayes,aes(Shape,sim_av,shape=ref_ecotype,col=y_rep)) +
  facet_wrap(~ as.factor(CZ_bayes$shore)) +
  geom_point(size=1.5) +
  geom_vline(xintercept = CZ_bayes$line) +
  scale_color_gradient(low = "black",high = "red") +
  labs(shape="ref. ecotype",x="shape", y=expression(mu),
       col="mount prob", title = "Predicted disassortative mating") +
  theme(legend.title = element_text(size = 11,face = "bold"),
        axis.title = element_text(face = "bold"),
        plot.title = element_text(size = 13,face = "bold",hjust = 0.5))

ggplot(CZ_bayes,aes(log_female,log_male,shape=ref_ecotype,col=sim_av)) +
  facet_wrap(~ as.factor(CZ_bayes$shore)) +
  geom_point(size=1.5) +
  scale_color_gradient2(low = "black",mid = "grey", high = "white",midpoint = 0.15) +
  labs(shape="ref. ecotype", col=expression(mu), x="female size",
       y="male size", title = "Predicted disassortative mating") +
  theme(legend.title = element_text(size = 11,face = "bold"),
        axis.title = element_text(face = "bold"),
        plot.title = element_text(size = 13,face = "bold",hjust = 0.5))
```
\fontsize{8}{9}
\selectfont
Figure 6. **Does $\mu$ depend on both the shore and the reference ecotype effect?** Successful mating pairs are generally composed by individuals of similar shapes and a female larger than a male up to an average optimum that differs marginally across shores and between ecotypes (CZA, crab = 0.19 $\pm$ 0.04 and wave = 0.17 $\pm$ 0.03; CZB, crab = 0.19 $\pm$ 0.03 and wave = 0.16 $\pm$ 0.03; CZC, crab = 0.15 $\pm$ 0.05 and wave = 0.13 $\pm$ 0.03; left panel). The lowest values of $\mu$ are produced when the reference is wave and the test is crab. Average estimates are measured for similar sizes and shapes (right panel).
\normalsize

$\vspace{1cm}$

\fontsize{8}{9}
\selectfont
\begin{center}
Table 6. Generated estimates for the reference ecotype parameters. All the intervals are close to 0 and show minor deviations between crab [1] and wave [2]. The ecotypes differ mainly for the term $level$ and $rtail$. Only the mean and the standard deviation of each equation terms are reported for the total crab and wave reference ecotype.
\end{center}
\small
```{r table6, message=FALSE, warning=FALSE, echo=FALSE}
CZ_gau2_delta = read.csv("../CZ_ABCD/results/CZABCD_gau2_delta.csv",sep = ";")
names(CZ_gau2_delta) = c("parameter","mean","se_mean","sd","2.5%","25%","50%","75%","97.5%","n_eff","Rhat")
pander(CZ_gau2_delta)
library(dplyr)
CZ_gau2_ref = group_by(CZ_bayes, ref_ecotype) %>%
  summarise(
    count = n(),
    level = mean(sim_le, na.rm = TRUE),
    lev_sd = sd(sim_le, na.rm = TRUE),
    mu = mean(sim_av, na.rm = TRUE),
    mu_sd = sd(sim_av, na.rm = TRUE),
    sigma = mean(sim_sd, na.rm = TRUE),
    sig_sd = sd(sim_sd, na.rm = TRUE),
    tail = mean(sim_ta, na.rm = TRUE),
    tail_sd = sd(sim_ta, na.rm = TRUE)
  )
pander(CZ_gau2_ref)
```
\normalsize

\newpage

## Preliminary conclusions

**1. Standard logistic regression**

The patterns of mate choice in _L. saxatilis_ are not exactly straightforward and it is not unusual for a sympatric scenario where incipient populations have not developed robust prezygotic barriers [@Kopp2017]. Although mechanisms of mate discrimination have been previously identified [@Hollander2005; @Johannesson2008], there was no evidence of precopulatory inbreeding avoidance between wild and sib individuals [@Ng2016]. Furthermore, the dense intertidal populations have lost the superfluous production of pheromones which are often used for precopulatory choice in other organisms [@Mays2004]. Assortative mating was recognised to be dependent on size [@Erlandsson1998; @Johannesson2008] but other preferences might contribute in multiple mechanisms during the speciation process like in the case of the treehoppers [@Cocroft2008].

The most likely hypothesis of sexual isolation in the intertidal snails involves the occurrence of reproductive barriers after copulation and before zygosis where the female preference acts upon the pool of stored sperms. Under the circumstances of convenience polyandry and postcopulatory sexual selection [@Panova2010; @Johannesson2016], the patterns of premating behaviour are expected to be relatively indefinite. Consequently, it is legitimate if the procedure of model selection did not return a single and unequivocal relationships between phenotypes and probability of mounting.

All the models built under a standard logistic regression contained the significant effects of size ratio, size ratio squared, size ratio cube, shape and shore. Therefore, the mounting success is certainly determined by the size difference between males and females, by the shape of the shell and by the environmental properties of the shore. These are interpretations well supported by both the data collected during the mating experiments and previous studies [@Erlandsson1998; @Johannesson2008]. The main challenges are introduced when accurate predictions of mounting probability lead to different biological explanations. For example, the presence of the interaction effect with the variable reference ecotype implies the additional preference for the typical traits of either wave or crab morph. Premating isolation in the species _L. saxatilis_ shows a strong component of shell size but the evolution of the reproductive barriers cannot simply involve a single mechanism. The results from multiple and robust models underline the delicate patterns of mate choice during speciation with gene flow.

$\vspace{1cm}$

**2. Gaussian formulation**

The major difference between the standard approach and the Gaussian formulation consists of the degree of resolution and depth that each analysis can provide. The four terms of the mating equation are defined as linear effects of several covariates and each of them controls for a specific factors of the probability curve. The height, the mean, the standard deviation and the tail asymmetry are manipulated by parameters associated with the selected variables such as shore, reference ecotype and shape. The parameters are given weakly informative priors and the derived posterior distributions are used for the prediction of the main effects on the probability of mounting. Hence, the mechanism of mate choice can be practically divided into the four principal components that underlie the patterns of assortative mating in _L. saxatilis_.

The first one is the term $level$ or the intercept of the curve. It takes the lowest value in the shore CZD while keeping a difference between crab and wave reference ecotype. The latter is responsible for the minimum estimate of the probability of mounting success when the other terms of the equation are equal to zero.

_I am still confused about the meaning of the intercept, what could be the biological explanation for the more negative values in wave than in crab?_

The second factor is the term $\mu$ and it stands for the mean of the probability curve. It was found to depend marginally on the reference ecotype and the test shape. The mounting probability is predicted to achieve the peak when both the individuals of the mating pair share similar ecotype characteristics. Nevertheless, this result is contrasted by a much stronger effect determined by the difference in size between females and males of the mating pairs. Shell size can be considered the most important effect that influences the optimum of mounting success which is obtained at $\mu = 0.15$.

The third one is defined as $\sigma$ and it represents the standard deviation of the mounting curve. Its strength varies according to both the shore conditions and the ecotype characteristics of the mating pairs. The lowest intensity was estimated in the shore CZC but the pattern of variation was consistent across locations even though the differences were measured on a small scale. When the reference snail belongs to the wave ecotype, the values of sigma decreases as the test snail becomes wave-like. The opposite is true for a crab reference because the width grows narrow as the test snail resembles the wave ecotype. Overall, the mating pairs composed by a crab reference and a wave-like test snail are the most affected by sexual selection.

The fourth component is $rtail$ and its values are proportional to the degree of asymmetry between the right and the left tail of the probability curve. The most negative values were generated for the combinations of males larger than females and for reference snails that belonged to the crab ecotype, with a small negative effect of the shape of the test snail.

_What else could we conclude from the tail asymmetry?_

Assortative or disassortative mating can generate sexual selection if it reduces trait variation of successful individuals in one sex. Individuals of the species _L. saxatilis_ exhibit a mounting strategy that is primarily based on the shell size of the potential partners. The highest mounting success is obtained for encounters in which the female is 1.2 times larger than the male. Therefore, it is generally advantageous for males to maintain small shell sizes. The optimum difference in size between males and females creates a candidate scenario for sexual selection to unfold. Nevertheless, the current study cannot establish whether sexual selection promotes or inhibits the divergence progress. In fact, the consequences of the mating patterns are tightly connected to the genetic basis of the female preference and the male mating trait. The strength of linkage disequilibrium under a preference/trait rule is a crucial factor for the effects of sexual selection on speciation with gene flow.


\newpage

# References
